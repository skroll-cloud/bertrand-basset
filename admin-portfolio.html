<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Bertrand Basset Portfolio</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a1a; color: #fff; min-height: 100vh; }
        
        .header { background: #111; padding: 1rem 2rem; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 1.2rem; font-weight: 500; }
        .header-actions { display: flex; gap: 1rem; }
        
        .btn { padding: 0.6rem 1.2rem; border: none; border-radius: 4px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #007AFF; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #333; color: white; }
        .btn-secondary:hover { background: #444; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #d63031; color: white; }
        .btn-danger:hover { background: #b52828; }
        
        .container { display: flex; height: calc(100vh - 60px); }
        
        .sidebar { width: 250px; background: #111; border-right: 1px solid #333; overflow-y: auto; padding: 1rem 0; }
        .sidebar-item { padding: 0.7rem 1.5rem; cursor: pointer; transition: background 0.2s; font-size: 0.9rem; }
        .sidebar-item:hover { background: #222; }
        .sidebar-item.active { background: #007AFF; }
        .sidebar-section { padding: 0.5rem 1.5rem; font-size: 0.7rem; text-transform: uppercase; color: #666; margin-top: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .btn-add { background: #007AFF; color: white; border: none; border-radius: 4px; width: 22px; height: 22px; font-size: 1rem; cursor: pointer; }
        .btn-add:hover { background: #0056b3; }
        
        .main { flex: 1; overflow-y: auto; padding: 2rem; }
        
        .gallery-header { margin-bottom: 2rem; }
        .gallery-header h2 { font-size: 1.5rem; font-weight: 500; margin-bottom: 1rem; }
        .gallery-meta { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        
        .form-group { display: flex; flex-direction: column; gap: 0.4rem; }
        .form-group label { font-size: 0.75rem; color: #888; text-transform: uppercase; display: flex; justify-content: space-between; }
        .form-group input, .form-group textarea, .form-group select { padding: 0.6rem; background: #222; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 0.9rem; font-family: inherit; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #007AFF; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .char-count { font-size: 0.7rem; color: #666; }
        .char-count.over { color: #d63031; }
        
        .section-title { font-size: 1rem; font-weight: 500; margin: 2rem 0 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        
        /* Videos section */
        .videos-list { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; }
        .video-item { display: flex; align-items: center; gap: 1rem; padding: 0.8rem; background: #222; border-radius: 4px; }
        .video-item select { width: 100px; }
        .video-item input { flex: 1; }
        .video-item .btn-remove { padding: 0.4rem 0.8rem; }
        
        /* Images grid */
        .images-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .image-card { background: #222; border-radius: 8px; overflow: hidden; cursor: grab; transition: transform 0.2s, box-shadow 0.2s; position: relative; }
        .image-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .image-card.dragging { opacity: 0.5; }
        .image-card.drag-over { border: 2px dashed #007AFF; }
        .image-card img { width: 100%; height: 150px; object-fit: cover; display: block; }
        .image-card-body { padding: 0.8rem; }
        .image-card-title { font-size: 0.7rem; color: #888; margin-bottom: 0.5rem; word-break: break-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .image-card-caption { width: 100%; padding: 0.5rem; background: #333; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 0.75rem; resize: none; height: 50px; font-family: inherit; }
        .image-card-caption:focus { outline: none; border-color: #007AFF; }
        
        .image-card-audio { margin-top: 0.5rem; }
        .image-card-audio select { width: 100%; padding: 0.4rem; background: #333; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 0.75rem; }
        .image-card-audio.has-audio select { border-color: #00b894; }
        
        .image-card-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        .image-card-actions button { flex: 1; padding: 0.4rem; font-size: 0.7rem; border: none; border-radius: 4px; cursor: pointer; }
        .btn-remove { background: #d63031; color: white; }
        
        .order-indicator { position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; }
        
        .drop-zone { border: 2px dashed #444; border-radius: 8px; padding: 2rem; text-align: center; color: #666; margin-top: 1rem; transition: all 0.2s; }
        .drop-zone.drag-over { border-color: #007AFF; background: rgba(0, 122, 255, 0.1); color: #007AFF; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: #222; border-radius: 8px; padding: 2rem; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h3 { font-size: 1.2rem; }
        .modal-close { background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; }
        
        .export-preview { background: #111; border-radius: 4px; padding: 1rem; font-family: monospace; font-size: 0.7rem; max-height: 300px; overflow: auto; white-space: pre-wrap; color: #0f0; }
        
        .toast { position: fixed; bottom: 2rem; right: 2rem; background: #28a745; color: white; padding: 1rem 1.5rem; border-radius: 4px; display: none; z-index: 1001; }
        .toast.active { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .instructions { background: #222; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; }
        .instructions h3 { margin-bottom: 1rem; font-size: 1rem; }
        .instructions ul { list-style: none; font-size: 0.85rem; color: #aaa; }
        .instructions li { padding: 0.3rem 0; padding-left: 1.5rem; position: relative; }
        .instructions li:before { content: "‚Üí"; position: absolute; left: 0; color: #007AFF; }
        
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    </style>
</head>
<body>
    <header class="header">
        <h1>üì∑ Admin Portfolio - Bertrand Basset</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="importConfig()">üì• Importer config</button>
            <button class="btn btn-success" onclick="exportConfig()">üíæ Exporter gallery.js</button>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-section">Galeries <button class="btn-add" onclick="addNewGallery()">+</button></div>
            <div id="galleriesList"></div>
            
            <div class="sidebar-section">Pages</div>
            <div class="sidebar-item" onclick="editPage('about')">√Ä propos</div>
            <div class="sidebar-item" onclick="editPage('contact')">Contact</div>
        </aside>

        <main class="main" id="mainContent">
            <div class="instructions">
                <h3>Bienvenue dans l'admin</h3>
                <ul>
                    <li>S√©lectionne une galerie dans le menu √† gauche</li>
                    <li>La description s'affiche en premi√®re slide</li>
                    <li>Ajoute des vid√©os YouTube/Vimeo</li>
                    <li>Glisse-d√©pose les images pour changer l'ordre</li>
                    <li>S√©lectionne un fichier audio pour chaque image</li>
                    <li>Clique sur "Exporter gallery.js" quand tu as fini</li>
                </ul>
            </div>
        </main>
    </div>

    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Exporter gallery.js</h3>
                <button class="modal-close" onclick="closeModal('exportModal')">&times;</button>
            </div>
            <p style="margin-bottom: 1rem; color: #888; font-size: 0.85rem;">
                Copie ce code et remplace le contenu de <code>js/gallery.js</code>
            </p>
            <pre class="export-preview" id="exportPreview"></pre>
            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                <button class="btn btn-primary" onclick="copyToClipboard()">üìã Copier</button>
                <button class="btn btn-success" onclick="downloadFile()">‚¨áÔ∏è T√©l√©charger</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Sauvegard√© !</div>

    <script>
        const MAX_DESCRIPTION_CHARS = 200;
        const MAX_CAPTION_CHARS = 100;
        
        let galleriesConfig = {
            "accueil": { title: "Accueil", path: "images/accueil", description: "", videos: [], images: [] },
            "portrait": { title: "Portrait", path: "images/photography/portrait", description: "", videos: [], images: [] },
            "gem": { title: "Le GEM s'endimanche", path: "images/photography/serie-portrait/gem", description: "S√©rie de portraits r√©alis√©e au GEM de Morlaix.", projectTitle: "Le GEM s'endimanche", projectLink: "projects/le-gem.html", videos: [], images: [] },
            "carre-das": { title: "Carr√© d'As", path: "images/photography/serie-portrait/Carr√© D'as", description: "", videos: [], images: [] },
            "burning-man": { title: "Burning Man", path: "images/photography/immersion/Burning Man", description: "", videos: [], images: [] },
            "st-melar": { title: "St M√©lar", path: "images/photography/immersion/St M√©lar", description: "", videos: [], images: [] },
            "cinema": { title: "Cin√©ma", path: "images/filmmaker/cinema", description: "", videos: [], images: [] },
            "television": { title: "T√©l√©vision", path: "images/filmmaker/Television", description: "", videos: [], images: [] }
        };

        let pagesContent = {
            about: { title: "√Ä propos", content: "Bertrand Basset\nPhotographe & R√©alisateur\n\nBas√© en Bretagne..." },
            contact: { title: "Contact", content: "contact@bertrandbasset.com\nCarantec, Finist√®re" }
        };

        let currentGallery = null;
        let audioFiles = {};

        document.addEventListener('DOMContentLoaded', () => {
            loadSavedConfig();
            renderGalleriesList();
        });

        function loadSavedConfig() {
            const saved = localStorage.getItem('portfolioConfigV2');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    galleriesConfig = data.galleries || galleriesConfig;
                    pagesContent = data.pages || pagesContent;
                    audioFiles = data.audioFiles || {};
                } catch(e) { console.error('Error loading config:', e); }
            }
        }

        function saveConfig() {
            localStorage.setItem('portfolioConfigV2', JSON.stringify({
                galleries: galleriesConfig,
                pages: pagesContent,
                audioFiles: audioFiles
            }));
            showToast('Sauvegard√© !');
        }

        function renderGalleriesList() {
            const list = document.getElementById('galleriesList');
            list.innerHTML = '';
            for (const [id, gallery] of Object.entries(galleriesConfig)) {
                const item = document.createElement('div');
                item.className = 'sidebar-item' + (currentGallery === id ? ' active' : '');
                const count = gallery.images.length + (gallery.videos?.length || 0);
                item.textContent = gallery.title + ` (${count})`;
                item.onclick = () => selectGallery(id);
                list.appendChild(item);
            }
        }

        function selectGallery(id) {
            currentGallery = id;
            renderGalleriesList();
            renderGalleryEditor(id);
        }

        function addNewGallery() {
            const name = prompt('Nom de la galerie:');
            if (!name) return;
            const id = name.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
            if (galleriesConfig[id]) { alert('Cette galerie existe d√©j√† !'); return; }
            const path = prompt('Chemin du dossier images:', 'images/');
            if (!path) return;
            galleriesConfig[id] = { title: name, path: path, description: '', videos: [], images: [] };
            saveConfig();
            renderGalleriesList();
            selectGallery(id);
        }

        function deleteGallery(id) {
            if (!confirm(`Supprimer la galerie "${galleriesConfig[id].title}" ?`)) return;
            delete galleriesConfig[id];
            saveConfig();
            renderGalleriesList();
            currentGallery = null;
            document.getElementById('mainContent').innerHTML = '<div class="instructions"><h3>Galerie supprim√©e</h3></div>';
        }

        function renderGalleryEditor(id) {
            const gallery = galleriesConfig[id];
            const descLength = (gallery.description || '').length;
            const main = document.getElementById('mainContent');
            
            main.innerHTML = `
                <div class="gallery-header">
                    <div class="header-row">
                        <h2>${gallery.title}</h2>
                        <button class="btn btn-danger" onclick="deleteGallery('${id}')">üóëÔ∏è Supprimer</button>
                    </div>
                    
                    <div class="gallery-meta">
                        <div class="form-group">
                            <label>Titre</label>
                            <input type="text" value="${gallery.title}" onchange="updateMeta('${id}', 'title', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Chemin images</label>
                            <input type="text" value="${gallery.path}" onchange="updateMeta('${id}', 'path', this.value)">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            Description (1√®re slide)
                            <span class="char-count ${descLength > MAX_DESCRIPTION_CHARS ? 'over' : ''}">${descLength}/${MAX_DESCRIPTION_CHARS}</span>
                        </label>
                        <textarea 
                            id="descriptionField"
                            maxlength="${MAX_DESCRIPTION_CHARS}"
                            onkeyup="updateCharCount(this, ${MAX_DESCRIPTION_CHARS})"
                            onchange="updateMeta('${id}', 'description', this.value)">${gallery.description || ''}</textarea>
                    </div>
                </div>
                
                <div class="section-title">
                    Vid√©os
                    <button class="btn btn-primary" onclick="addVideo('${id}')">+ Ajouter vid√©o</button>
                </div>
                <div class="videos-list" id="videosList">${renderVideos(id)}</div>
                
                <div class="section-title">Images (${gallery.images.length})</div>
                <div class="images-grid" id="imagesGrid">${renderImages(id)}</div>
                
                <div class="drop-zone" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleFileDrop(event, '${id}')">
                    üìÅ Glisse des images ici pour les ajouter
                </div>
            `;
            
            initDragAndDrop(id);
        }

        function renderVideos(galleryId) {
            const gallery = galleriesConfig[galleryId];
            if (!gallery.videos || gallery.videos.length === 0) {
                return '<p style="color: #666; font-size: 0.85rem;">Aucune vid√©o. Clique sur "+ Ajouter vid√©o" pour en ajouter.</p>';
            }
            return gallery.videos.map((video, i) => `
                <div class="video-item">
                    <select onchange="updateVideo('${galleryId}', ${i}, 'type', this.value)">
                        <option value="youtube" ${video.type === 'youtube' ? 'selected' : ''}>YouTube</option>
                        <option value="vimeo" ${video.type === 'vimeo' ? 'selected' : ''}>Vimeo</option>
                    </select>
                    <input type="text" placeholder="ID de la vid√©o" value="${video.id || ''}" onchange="updateVideo('${galleryId}', ${i}, 'id', this.value)">
                    <input type="text" placeholder="Titre (optionnel)" value="${video.title || ''}" onchange="updateVideo('${galleryId}', ${i}, 'title', this.value)">
                    <button class="btn btn-remove" onclick="removeVideo('${galleryId}', ${i})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function addVideo(galleryId) {
            if (!galleriesConfig[galleryId].videos) galleriesConfig[galleryId].videos = [];
            galleriesConfig[galleryId].videos.push({ type: 'vimeo', id: '', title: '' });
            saveConfig();
            renderGalleryEditor(galleryId);
        }

        function updateVideo(galleryId, index, field, value) {
            galleriesConfig[galleryId].videos[index][field] = value;
            saveConfig();
        }

        function removeVideo(galleryId, index) {
            galleriesConfig[galleryId].videos.splice(index, 1);
            saveConfig();
            renderGalleryEditor(galleryId);
        }

        function renderImages(galleryId) {
            const gallery = galleriesConfig[galleryId];
            const audioList = audioFiles[galleryId] || [];
            
            return gallery.images.map((img, index) => {
                const filename = typeof img === 'string' ? img : img.filename;
                const caption = typeof img === 'object' ? (img.caption || '') : '';
                const audio = typeof img === 'object' ? (img.audio || '') : '';
                const imgPath = `${gallery.path}/${filename}`;
                
                return `
                    <div class="image-card" draggable="true" data-index="${index}">
                        <span class="order-indicator">${index + 1}</span>
                        <img src="${imgPath}" alt="${filename}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23666%22 font-size=%228%22>Image</text></svg>'">
                        <div class="image-card-body">
                            <div class="image-card-title" title="${filename}">${filename}</div>
                            <textarea class="image-card-caption" placeholder="L√©gende..." maxlength="${MAX_CAPTION_CHARS}" onchange="updateCaption('${galleryId}', ${index}, this.value)">${caption}</textarea>
                            <div class="image-card-audio ${audio ? 'has-audio' : ''}">
                                <select onchange="updateAudio('${galleryId}', ${index}, this.value)">
                                    <option value="">-- Pas d'audio --</option>
                                    ${getAudioOptions(galleryId, audio)}
                                </select>
                            </div>
                            <div class="image-card-actions">
                                <button class="btn-remove" onclick="removeImage('${galleryId}', ${index})">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getAudioOptions(galleryId, selectedAudio) {
            const audioList = audioFiles[galleryId] || [];
            return audioList.map(file => 
                `<option value="${file}" ${file === selectedAudio ? 'selected' : ''}>${file}</option>`
            ).join('');
        }

        function updateCharCount(el, max) {
            const label = el.parentElement.querySelector('.char-count');
            const len = el.value.length;
            label.textContent = `${len}/${max}`;
            label.classList.toggle('over', len > max);
        }

        function updateMeta(id, field, value) {
            galleriesConfig[id][field] = value;
            saveConfig();
            renderGalleriesList();
        }

        function updateCaption(galleryId, index, caption) {
            const img = galleriesConfig[galleryId].images[index];
            if (typeof img === 'string') {
                galleriesConfig[galleryId].images[index] = { filename: img, caption: caption };
            } else {
                img.caption = caption;
            }
            saveConfig();
        }

        function updateAudio(galleryId, index, audioFile) {
            const img = galleriesConfig[galleryId].images[index];
            if (typeof img === 'string') {
                galleriesConfig[galleryId].images[index] = { filename: img, audio: audioFile || null };
            } else {
                img.audio = audioFile || null;
            }
            saveConfig();
            renderGalleryEditor(galleryId);
        }

        function removeImage(galleryId, index) {
            galleriesConfig[galleryId].images.splice(index, 1);
            saveConfig();
            renderGalleryEditor(galleryId);
            renderGalleriesList();
        }

        function addImage(galleryId, filename) {
            galleriesConfig[galleryId].images.push({ filename: filename, caption: '' });
            saveConfig();
            renderGalleryEditor(galleryId);
            renderGalleriesList();
        }

        // Drag and drop
        function initDragAndDrop(galleryId) {
            const grid = document.getElementById('imagesGrid');
            if (!grid) return;
            grid.querySelectorAll('.image-card').forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    card.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', card.dataset.index);
                });
                card.addEventListener('dragend', () => card.classList.remove('dragging'));
                card.addEventListener('dragover', (e) => { e.preventDefault(); card.classList.add('drag-over'); });
                card.addEventListener('dragleave', () => card.classList.remove('drag-over'));
                card.addEventListener('drop', (e) => {
                    e.preventDefault();
                    card.classList.remove('drag-over');
                    const from = parseInt(e.dataTransfer.getData('text/plain'));
                    const to = parseInt(card.dataset.index);
                    if (from !== to) {
                        const images = galleriesConfig[galleryId].images;
                        const [moved] = images.splice(from, 1);
                        images.splice(to, 0, moved);
                        saveConfig();
                        renderGalleryEditor(galleryId);
                    }
                });
            });
        }

        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        function handleFileDrop(e, galleryId) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            Array.from(e.dataTransfer.files).forEach(file => {
                if (file.type.startsWith('image/')) addImage(galleryId, file.name);
                if (file.type.startsWith('audio/') || file.name.endsWith('.mp3')) {
                    if (!audioFiles[galleryId]) audioFiles[galleryId] = [];
                    if (!audioFiles[galleryId].includes(file.name)) {
                        audioFiles[galleryId].push(file.name);
                        saveConfig();
                    }
                }
            });
            renderGalleryEditor(galleryId);
        }

        // Pages
        function editPage(pageId) {
            currentGallery = null;
            renderGalleriesList();
            const page = pagesContent[pageId];
            document.getElementById('mainContent').innerHTML = `
                <div class="gallery-header"><h2>${page.title}</h2></div>
                <div class="form-group">
                    <label>Contenu de la page</label>
                    <textarea style="min-height: 300px;" onchange="pagesContent['${pageId}'].content = this.value; saveConfig();">${page.content}</textarea>
                </div>
            `;
        }

        // Import/Export
        function importConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.js';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const text = await file.text();
                try {
                    const match = text.match(/const GALLERIES_CONFIG = ({[\s\S]*?});/);
                    if (match) {
                        const config = eval('(' + match[1] + ')');
                        for (const [id, gallery] of Object.entries(config)) {
                            galleriesConfig[id] = {
                                title: gallery.title,
                                path: gallery.path,
                                description: gallery.description || '',
                                projectTitle: gallery.projectTitle,
                                projectLink: gallery.projectLink,
                                videos: gallery.videos || [],
                                images: gallery.images.map(img => typeof img === 'string' ? { filename: img } : img)
                            };
                            // Extract audio files
                            audioFiles[id] = [];
                            gallery.images.forEach(img => {
                                if (typeof img === 'object' && img.audio) {
                                    const audioName = img.audio.split('/').pop();
                                    if (!audioFiles[id].includes(audioName)) audioFiles[id].push(audioName);
                                }
                            });
                        }
                        saveConfig();
                        renderGalleriesList();
                        showToast('Configuration import√©e !');
                    }
                } catch(err) { alert('Erreur: ' + err.message); }
            };
            input.click();
        }

        function exportConfig() {
            document.getElementById('exportPreview').textContent = generateGalleryJS();
            document.getElementById('exportModal').classList.add('active');
        }

        function generateGalleryJS() {
            let js = `/**
 * Bertrand Basset Portfolio - V8
 * Generated by Admin
 */

const GALLERIES_CONFIG = {\n`;

            for (const [id, g] of Object.entries(galleriesConfig)) {
                js += `    "${id}": {\n`;
                js += `        title: "${g.title}",\n`;
                js += `        path: "${g.path}",\n`;
                if (g.description) js += `        description: "${g.description.replace(/"/g, '\\"').replace(/\n/g, '\\n')}",\n`;
                if (g.projectTitle) {
                    js += `        projectTitle: "${g.projectTitle}",\n`;
                    js += `        projectLink: "${g.projectLink || ''}",\n`;
                }
                if (g.videos && g.videos.length > 0) {
                    js += `        videos: [\n`;
                    g.videos.forEach((v, i) => {
                        js += `            { type: "${v.type}", id: "${v.id}", title: "${v.title || ''}" }${i < g.videos.length - 1 ? ',' : ''}\n`;
                    });
                    js += `        ],\n`;
                }
                js += `        images: [\n`;
                g.images.forEach((img, i) => {
                    const filename = typeof img === 'string' ? img : img.filename;
                    const caption = typeof img === 'object' ? img.caption : '';
                    const audio = typeof img === 'object' ? img.audio : null;
                    if (caption || audio) {
                        js += `            { filename: "${filename}"`;
                        if (caption) js += `, caption: "${caption.replace(/"/g, '\\"')}"`;
                        if (audio) js += `, audio: "${audio}"`;
                        js += ` }`;
                    } else {
                        js += `            "${filename}"`;
                    }
                    js += i < g.images.length - 1 ? ',\n' : '\n';
                });
                js += `        ]\n    },\n`;
            }
            js += `};\n\n`;
            js += getPortfolioClassCode();
            return js;
        }

        function getPortfolioClassCode() {
            return `const PAGES_CONTENT = {
    about: { title: "√Ä propos", content: ${JSON.stringify(pagesContent.about.content)} },
    contact: { title: "Contact", content: ${JSON.stringify(pagesContent.contact.content)} }
};

const TRANSLATIONS = {
    en: { "photography": "Photography", "portrait": "Portrait", "serie-portrait": "Serie Portrait", "immersion": "Immersion", "filmmaker": "Filmmaker", "cinema": "Cinema", "television": "Television", "about": "About", "contact": "Contact", "learn-more": "learn more", "prev": "prev", "next": "next", "show-thumbnails": "show thumbnails", "hide-thumbnails": "hide thumbnails", "play": "play", "pause": "pause" },
    fr: { "photography": "Photographie", "portrait": "Portrait", "serie-portrait": "S√©rie Portrait", "immersion": "Immersion", "filmmaker": "R√©alisateur", "cinema": "Cin√©ma", "television": "T√©l√©vision", "about": "√Ä propos", "contact": "Contact", "learn-more": "en savoir plus", "prev": "pr√©c", "next": "suiv", "show-thumbnails": "voir vignettes", "hide-thumbnails": "masquer vignettes", "play": "√©couter", "pause": "pause" }
};

class Portfolio {
    constructor() {
        this.galleries = this.buildGalleries();
        this.currentGallery = null;
        this.currentIndex = 0;
        this.isTransitioning = false;
        this.currentAudio = null;
        this.isPlaying = false;
        this.currentLang = 'fr';
        this.isMobile = window.innerWidth <= 768;
        this.currentPage = null;
        this.init();
    }

    buildGalleries() {
        const galleries = {};
        for (const [id, config] of Object.entries(GALLERIES_CONFIG)) {
            const items = [];
            if (config.description) items.push({ type: 'description', title: config.title, text: config.description });
            if (config.videos) config.videos.forEach(v => items.push({ type: 'video', platform: v.type, videoId: v.id, title: v.title || '' }));
            config.images.forEach(img => {
                if (typeof img === 'string') items.push({ type: 'image', src: \`\${config.path}/\${img}\`, caption: '' });
                else items.push({ type: 'image', src: \`\${config.path}/\${img.filename}\`, caption: img.caption || '', audio: img.audio ? \`\${config.path}/\${img.audio}\` : null });
            });
            galleries[id] = { title: config.title, description: config.description || '', projectTitle: config.projectTitle || null, projectLink: config.projectLink || null, items };
        }
        return galleries;
    }

    init() { this.cacheElements(); this.bindEvents(); this.openGallery('accueil'); this.handleResize(); }

    cacheElements() {
        this.landing = document.getElementById('landing');
        this.site = document.getElementById('site');
        this.enterBtn = document.getElementById('enterBtn');
        this.menuToggle = document.getElementById('menuToggle');
        this.mainNav = document.getElementById('mainNav');
        this.galleryContainer = document.getElementById('galleryContainer');
        this.prevBtn = document.getElementById('prevBtn');
        this.nextBtn = document.getElementById('nextBtn');
        this.thumbnailsToggle = document.getElementById('thumbnailsToggle');
        this.thumbnailsPanel = document.getElementById('thumbnailsPanel');
        this.thumbnailsGrid = document.getElementById('thumbnailsGrid');
        this.thumbnailsClose = document.getElementById('thumbnailsClose');
        this.galleryCounter = document.querySelector('.gallery-counter');
        this.imageCaption = document.querySelector('.image-caption');
        this.navItems = document.querySelectorAll('.nav-item[data-expandable]');
        this.dropdownLinks = document.querySelectorAll('.dropdown-link:not(.has-submenu)');
        this.submenuLinks = document.querySelectorAll('.dropdown-link.has-submenu');
        this.dropdownSublinks = document.querySelectorAll('.dropdown-sublink');
        this.projectInfo = document.querySelector('.project-info');
        this.projectTitle = document.querySelector('.project-title');
        this.projectLink = document.querySelector('.project-link');
        this.audioControls = document.querySelector('.audio-controls');
        this.audioBtn = document.getElementById('audioBtn');
        this.homeLink = document.getElementById('homeLink');
        this.langLinks = document.querySelectorAll('[data-lang]');
        this.cursor = document.getElementById('customCursor');
    }

    bindEvents() {
        if (this.enterBtn) this.enterBtn.addEventListener('click', () => this.enterSite());
        if (this.homeLink) this.homeLink.addEventListener('click', (e) => { e.preventDefault(); this.currentPage = null; this.openGallery('accueil'); this.closeMenu(); });
        if (this.menuToggle) this.menuToggle.addEventListener('click', () => this.toggleMenu());
        this.navItems.forEach(item => { const link = item.querySelector('.nav-link'); if (link) link.addEventListener('click', (e) => { e.preventDefault(); this.toggleNavItem(item); }); });
        this.dropdownLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const gid = link.dataset.gallery; if (gid) { this.currentPage = null; this.openGallery(gid); this.closeMenu(); } }); });
        this.submenuLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); link.classList.toggle('open'); }); });
        this.dropdownSublinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const gid = link.dataset.gallery; if (gid) { this.currentPage = null; this.openGallery(gid); this.closeMenu(); } }); });
        document.querySelectorAll('[data-page]').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); this.showPage(link.dataset.page); this.closeMenu(); }); });
        if (this.prevBtn) this.prevBtn.addEventListener('click', (e) => { e.preventDefault(); this.prevItem(); });
        if (this.nextBtn) this.nextBtn.addEventListener('click', (e) => { e.preventDefault(); this.nextItem(); });
        if (this.galleryContainer) {
            this.galleryContainer.addEventListener('click', (e) => {
                if (e.target.closest('.video-container') || this.currentPage) return;
                const rect = this.galleryContainer.getBoundingClientRect();
                if ((e.clientX - rect.left) < rect.width / 2) this.prevItem(); else this.nextItem();
            });
            this.galleryContainer.addEventListener('mousemove', (e) => {
                if (!this.isMobile && this.cursor) {
                    this.cursor.style.left = e.clientX + 'px';
                    this.cursor.style.top = e.clientY + 'px';
                    const rect = this.galleryContainer.getBoundingClientRect();
                    this.cursor.innerHTML = (e.clientX - rect.left) < rect.width / 2 ? '<svg viewBox="0 0 24 24"><polyline points="15,6 9,12 15,18"></polyline></svg>' : '<svg viewBox="0 0 24 24"><polyline points="9,6 15,12 9,18"></polyline></svg>';
                }
            });
            this.galleryContainer.addEventListener('mouseenter', () => { if (!this.isMobile && this.cursor) this.cursor.classList.add('visible'); });
            this.galleryContainer.addEventListener('mouseleave', () => { if (this.cursor) this.cursor.classList.remove('visible'); });
        }
        if (this.thumbnailsToggle) this.thumbnailsToggle.addEventListener('click', (e) => { e.preventDefault(); this.toggleThumbnails(); });
        if (this.thumbnailsClose) this.thumbnailsClose.addEventListener('click', () => this.hideThumbnails());
        if (this.audioBtn) this.audioBtn.addEventListener('click', (e) => { e.preventDefault(); this.toggleAudio(); });
        document.addEventListener('keydown', (e) => this.handleKeyboard(e));
        this.initSwipe();
        this.langLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); this.setLanguage(link.dataset.lang); }); });
        window.addEventListener('resize', () => this.handleResize());
    }

    toggleMenu() { if (this.menuToggle) this.menuToggle.classList.toggle('open'); if (this.mainNav) this.mainNav.classList.toggle('open'); }
    closeMenu() { if (this.menuToggle) this.menuToggle.classList.remove('open'); if (this.mainNav) this.mainNav.classList.remove('open'); }
    handleResize() { this.isMobile = window.innerWidth <= 768; if (!this.isMobile) this.closeMenu(); }
    enterSite() { if (this.landing) this.landing.classList.add('hidden'); if (this.site) this.site.classList.add('active'); }
    toggleNavItem(item) { const wasOpen = item.classList.contains('open'); this.navItems.forEach(n => { if (n !== item) n.classList.remove('open'); }); item.classList.toggle('open', !wasOpen); }

    showPage(pageId) {
        const page = PAGES_CONTENT[pageId];
        if (!page) return;
        this.currentPage = pageId;
        this.currentGallery = null;
        this.stopAudio();
        if (this.galleryCounter) this.galleryCounter.style.display = 'none';
        if (this.thumbnailsToggle) this.thumbnailsToggle.style.display = 'none';
        if (this.audioControls) this.audioControls.classList.remove('visible');
        if (this.projectInfo) this.projectInfo.classList.remove('visible');
        this.galleryContainer.innerHTML = \`<div class="page-content"><div class="page-text">\${page.content.replace(/\\n/g, '<br>')}</div></div>\`;
        this.galleryContainer.classList.add('page-mode');
    }

    openGallery(galleryId) {
        const gallery = this.galleries[galleryId];
        if (!gallery || !gallery.items.length) return;
        this.currentGallery = gallery;
        this.currentGalleryId = galleryId;
        this.currentIndex = 0;
        this.currentPage = null;
        if (this.galleryCounter) this.galleryCounter.style.display = '';
        if (this.thumbnailsToggle) this.thumbnailsToggle.style.display = '';
        this.galleryContainer.classList.remove('page-mode');
        this.showItem(0);
        this.generateThumbnails();
        this.updateProjectInfo();
    }

    showItem(index) {
        if (!this.currentGallery || this.isTransitioning) return;
        const items = this.currentGallery.items;
        if (index < 0 || index >= items.length) return;
        this.stopAudio();
        this.isTransitioning = true;
        this.currentIndex = index;
        const item = items[index];
        const current = this.galleryContainer.querySelector('.gallery-image, .description-slide, .video-container');
        if (current) current.classList.add('transitioning');
        setTimeout(() => {
            this.galleryContainer.innerHTML = '';
            if (item.type === 'description') this.showDescriptionSlide(item);
            else if (item.type === 'video') this.showVideoSlide(item);
            else this.showImageSlide(item);
            this.updateCounter();
            this.updateActiveThumbnail(index);
            this.updateAudioControls(item);
        }, 250);
    }

    showDescriptionSlide(item) {
        const div = document.createElement('div');
        div.className = 'description-slide';
        div.innerHTML = \`<div class="description-content"><h2 class="description-title">\${item.title}</h2><p class="description-text">\${item.text}</p></div>\`;
        this.galleryContainer.appendChild(div);
        setTimeout(() => { div.classList.add('loaded'); this.isTransitioning = false; }, 50);
        if (this.imageCaption) this.imageCaption.textContent = '';
    }

    showVideoSlide(item) {
        const div = document.createElement('div');
        div.className = 'video-container';
        const url = item.platform === 'vimeo' ? \`https://player.vimeo.com/video/\${item.videoId}?title=0&byline=0&portrait=0\` : \`https://www.youtube.com/embed/\${item.videoId}?rel=0\`;
        div.innerHTML = \`<iframe src="\${url}" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>\`;
        this.galleryContainer.appendChild(div);
        setTimeout(() => { div.classList.add('loaded'); this.isTransitioning = false; }, 50);
        if (this.imageCaption) this.imageCaption.textContent = item.title || '';
    }

    showImageSlide(item) {
        const img = document.createElement('img');
        img.className = 'gallery-image';
        img.alt = item.caption || '';
        img.loading = 'lazy';
        img.onload = () => { img.classList.add('loaded'); this.isTransitioning = false; };
        img.onerror = () => { this.isTransitioning = false; };
        this.galleryContainer.appendChild(img);
        img.src = encodeURI(item.src);
        if (this.imageCaption) this.imageCaption.textContent = item.caption || '';
        if (item.audio) this.playAudio(item.audio);
    }

    updateAudioControls(item) { if (this.audioControls) this.audioControls.classList.toggle('visible', item.type === 'image' && !!item.audio); }
    prevItem() { if (!this.currentGallery || this.currentPage) return; this.showItem(this.currentIndex > 0 ? this.currentIndex - 1 : this.currentGallery.items.length - 1); }
    nextItem() { if (!this.currentGallery || this.currentPage) return; this.showItem(this.currentIndex < this.currentGallery.items.length - 1 ? this.currentIndex + 1 : 0); }
    updateCounter() { if (this.galleryCounter && this.currentGallery) this.galleryCounter.textContent = \`\${this.currentIndex + 1} / \${this.currentGallery.items.length}\`; }

    playAudio(src) { this.stopAudio(); this.currentAudio = new Audio(encodeURI(src)); this.currentAudio.play().catch(() => {}); this.isPlaying = true; this.updateAudioButton(); this.currentAudio.addEventListener('ended', () => { this.isPlaying = false; this.updateAudioButton(); }); }
    stopAudio() { if (this.currentAudio) { this.currentAudio.pause(); this.currentAudio = null; this.isPlaying = false; this.updateAudioButton(); } }
    toggleAudio() { if (!this.currentGallery) return; const item = this.currentGallery.items[this.currentIndex]; if (!item || !item.audio) return; if (this.isPlaying) this.stopAudio(); else this.playAudio(item.audio); }
    updateAudioButton() { if (!this.audioBtn) return; const icon = this.audioBtn.querySelector('.audio-icon'); const label = this.audioBtn.querySelector('.audio-label'); if (this.isPlaying) { if (icon) icon.innerHTML = '&#9724;'; if (label) label.textContent = this.t('pause'); this.audioBtn.classList.add('playing'); } else { if (icon) icon.innerHTML = '&#9654;'; if (label) label.textContent = this.t('play'); this.audioBtn.classList.remove('playing'); } }

    handleKeyboard(e) { if (!this.site || !this.site.classList.contains('active') || this.currentPage) return; if (e.key === 'ArrowLeft') { e.preventDefault(); this.prevItem(); } if (e.key === 'ArrowRight') { e.preventDefault(); this.nextItem(); } if (e.key === 'Escape') { this.hideThumbnails(); this.closeMenu(); } if (e.key === ' ') { e.preventDefault(); this.toggleAudio(); } }
    initSwipe() { if (!this.galleryContainer) return; let startX = 0, startY = 0; this.galleryContainer.addEventListener('touchstart', (e) => { startX = e.changedTouches[0].screenX; startY = e.changedTouches[0].screenY; }, { passive: true }); this.galleryContainer.addEventListener('touchend', (e) => { if (this.currentPage) return; const diffX = startX - e.changedTouches[0].screenX; const diffY = Math.abs(startY - e.changedTouches[0].screenY); if (Math.abs(diffX) > 50 && diffY < 100) { if (diffX > 0) this.nextItem(); else this.prevItem(); } }, { passive: true }); }

    toggleThumbnails() { if (this.thumbnailsPanel) { this.thumbnailsPanel.classList.toggle('active'); if (this.thumbnailsToggle) this.thumbnailsToggle.textContent = this.thumbnailsPanel.classList.contains('active') ? this.t('hide-thumbnails') : this.t('show-thumbnails'); } }
    hideThumbnails() { if (this.thumbnailsPanel) { this.thumbnailsPanel.classList.remove('active'); if (this.thumbnailsToggle) this.thumbnailsToggle.textContent = this.t('show-thumbnails'); } }
    generateThumbnails() { if (!this.thumbnailsGrid || !this.currentGallery) return; this.thumbnailsGrid.innerHTML = ''; this.currentGallery.items.forEach((item, i) => { const thumb = document.createElement('div'); thumb.className = 'thumbnail-item' + (i === this.currentIndex ? ' active' : ''); if (item.type === 'description') { thumb.innerHTML = '<span class="thumb-text">T</span>'; thumb.classList.add('thumb-description'); } else if (item.type === 'video') { thumb.innerHTML = '<span class="thumb-video">‚ñ∂</span>'; thumb.classList.add('thumb-video-item'); } else { const img = document.createElement('img'); img.src = encodeURI(item.src); img.loading = 'lazy'; thumb.appendChild(img); } thumb.addEventListener('click', () => this.showItem(i)); this.thumbnailsGrid.appendChild(thumb); }); }
    updateActiveThumbnail(index) { if (!this.thumbnailsGrid) return; this.thumbnailsGrid.querySelectorAll('.thumbnail-item').forEach((t, i) => t.classList.toggle('active', i === index)); }
    updateProjectInfo() { if (!this.projectInfo || !this.currentGallery) return; if (this.currentGallery.projectTitle) { if (this.projectTitle) this.projectTitle.textContent = this.currentGallery.projectTitle; if (this.projectLink) this.projectLink.href = this.currentGallery.projectLink || '#'; this.projectInfo.classList.add('visible'); } else { this.projectInfo.classList.remove('visible'); } }
    setLanguage(lang) { if (!TRANSLATIONS[lang]) return; this.currentLang = lang; this.langLinks.forEach(l => l.classList.toggle('active', l.dataset.lang === lang)); document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.dataset.i18n; if (TRANSLATIONS[lang][key]) el.textContent = TRANSLATIONS[lang][key]; }); }
    t(key) { return TRANSLATIONS[this.currentLang][key] || key; }
}

document.addEventListener('DOMContentLoaded', () => { window.portfolio = new Portfolio(); });`;
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function copyToClipboard() { navigator.clipboard.writeText(document.getElementById('exportPreview').textContent).then(() => showToast('Copi√© !')); }
        function downloadFile() { const blob = new Blob([document.getElementById('exportPreview').textContent], { type: 'text/javascript' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'gallery.js'; a.click(); showToast('T√©l√©charg√© !'); }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('active'); setTimeout(() => t.classList.remove('active'), 2000); }
        document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', (e) => { if (e.target === m) m.classList.remove('active'); }));
    </script>
</body>
</html>
