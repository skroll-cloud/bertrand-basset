<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Bertrand Basset Portfolio</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a1a; color: #fff; min-height: 100vh; }
        
        .header { background: #111; padding: 0.8rem 1.5rem; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 1rem; font-weight: 500; }
        .header-actions { display: flex; gap: 0.6rem; }
        
        .btn { padding: 0.45rem 0.9rem; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #007AFF; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #333; color: white; }
        .btn-secondary:hover { background: #444; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #d63031; color: white; }
        .btn-danger:hover { background: #b52828; }
        .btn-small { padding: 0.25rem 0.5rem; font-size: 0.65rem; }
        .btn-icon { width: 24px; height: 24px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        
        .container { display: flex; height: calc(100vh - 52px); }
        
        /* SIDEBAR */
        .sidebar { width: 280px; background: #111; border-right: 1px solid #333; display: flex; flex-direction: column; flex-shrink: 0; }
        
        .sidebar-tabs { display: flex; border-bottom: 1px solid #333; }
        .sidebar-tab { flex: 1; padding: 0.7rem; text-align: center; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666; cursor: pointer; border-bottom: 2px solid transparent; }
        .sidebar-tab:hover { color: #aaa; }
        .sidebar-tab.active { color: #fff; border-bottom-color: #007AFF; }
        
        .sidebar-content { flex: 1; overflow-y: auto; padding: 0.8rem; }
        
        /* Menu Editor */
        .menu-section { margin-bottom: 1rem; }
        .menu-section-header { display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0; margin-bottom: 0.5rem; border-bottom: 1px solid #333; }
        .menu-section-title { font-size: 0.65rem; text-transform: uppercase; color: #666; letter-spacing: 0.05em; }
        
        .menu-tree { }
        
        .menu-item { background: #222; border-radius: 4px; margin-bottom: 0.4rem; overflow: hidden; }
        .menu-item.dragging { opacity: 0.5; }
        .menu-item.drag-over { border: 1px dashed #007AFF; }
        
        .menu-item-header { display: flex; align-items: center; padding: 0.5rem; gap: 0.5rem; cursor: grab; }
        .menu-item-header:active { cursor: grabbing; }
        
        .drag-handle { color: #555; font-size: 0.8rem; cursor: grab; }
        .menu-item-name { flex: 1; font-size: 0.8rem; }
        .menu-item-name input { background: transparent; border: none; color: #fff; font-size: 0.8rem; width: 100%; padding: 0.2rem; }
        .menu-item-name input:focus { outline: none; background: #333; border-radius: 2px; }
        
        .menu-item-actions { display: flex; gap: 0.2rem; }
        .menu-item-actions button { background: transparent; border: none; color: #666; cursor: pointer; padding: 0.2rem; font-size: 0.7rem; }
        .menu-item-actions button:hover { color: #fff; }
        
        .menu-item-toggle { background: none; border: none; color: #666; cursor: pointer; font-size: 0.6rem; padding: 0.2rem; transition: transform 0.2s; }
        .menu-item.open .menu-item-toggle { transform: rotate(90deg); }
        
        .menu-item-children { padding-left: 1rem; display: none; padding-bottom: 0.5rem; }
        .menu-item.open .menu-item-children { display: block; }
        
        .menu-item-link { font-size: 0.65rem; color: #007AFF; padding: 0.2rem 0.5rem; }
        
        .add-menu-item { display: flex; gap: 0.3rem; margin-top: 0.5rem; }
        .add-menu-item input { flex: 1; padding: 0.4rem; background: #222; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 0.75rem; }
        .add-menu-item input:focus { outline: none; border-color: #007AFF; }
        
        /* Galleries list */
        .gallery-list-item { display: flex; align-items: center; padding: 0.5rem 0.6rem; background: #222; border-radius: 4px; margin-bottom: 0.3rem; cursor: pointer; transition: background 0.2s; }
        .gallery-list-item:hover { background: #2a2a2a; }
        .gallery-list-item.active { background: #007AFF; }
        .gallery-list-item .name { flex: 1; font-size: 0.8rem; }
        .gallery-list-item .count { font-size: 0.65rem; color: #666; }
        .gallery-list-item.active .count { color: rgba(255,255,255,0.7); }
        
        /* Pages list */
        .page-list-item { padding: 0.5rem 0.6rem; background: #222; border-radius: 4px; margin-bottom: 0.3rem; cursor: pointer; font-size: 0.8rem; }
        .page-list-item:hover { background: #2a2a2a; }
        .page-list-item.active { background: #007AFF; }
        
        /* MAIN */
        .main { flex: 1; overflow-y: auto; padding: 1.5rem; background: #1a1a1a; }
        
        .editor-section { background: #222; border-radius: 6px; padding: 1.2rem; margin-bottom: 1rem; }
        .editor-section-title { font-size: 0.9rem; font-weight: 500; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }
        
        .form-row { display: flex; gap: 1rem; margin-bottom: 0.8rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.3rem; flex: 1; }
        .form-group.full { flex: 100%; }
        .form-group label { font-size: 0.65rem; color: #888; text-transform: uppercase; letter-spacing: 0.03em; }
        .form-group input, .form-group textarea, .form-group select { padding: 0.5rem; background: #333; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 0.8rem; font-family: inherit; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #007AFF; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        
        .checkbox-group { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0; }
        .checkbox-group input { width: 16px; height: 16px; cursor: pointer; }
        .checkbox-group label { font-size: 0.8rem; color: #aaa; cursor: pointer; }
        
        .char-count { font-size: 0.6rem; color: #666; margin-left: auto; }
        .char-count.over { color: #d63031; }
        
        /* Images grid */
        .images-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 0.8rem; }
        
        .image-card { background: #2a2a2a; border-radius: 6px; overflow: hidden; cursor: grab; position: relative; }
        .image-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .image-card.dragging { opacity: 0.5; }
        .image-card.drag-over { outline: 2px dashed #007AFF; }
        
        .image-card img { width: 100%; height: 100px; object-fit: cover; display: block; }
        .image-card-body { padding: 0.5rem; }
        .image-card-title { font-size: 0.6rem; color: #666; margin-bottom: 0.3rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .image-card textarea { width: 100%; padding: 0.3rem; background: #333; border: 1px solid #444; border-radius: 3px; color: #fff; font-size: 0.65rem; resize: none; height: 36px; font-family: inherit; }
        .image-card textarea:focus { outline: none; border-color: #007AFF; }
        
        .image-card-row { display: flex; gap: 0.3rem; margin-top: 0.3rem; }
        .image-card-row select { flex: 1; padding: 0.25rem; background: #333; border: 1px solid #444; border-radius: 3px; color: #fff; font-size: 0.6rem; }
        
        .image-option { display: flex; align-items: center; gap: 0.3rem; margin-top: 0.3rem; padding: 0.3rem; background: #333; border-radius: 3px; }
        .image-option input[type="checkbox"] { width: 12px; height: 12px; }
        .image-option label { font-size: 0.6rem; color: #888; }
        .image-option.active { background: #1a3a1a; }
        .image-option.active label { color: #4ade80; }
        
        .image-option input[type="text"] { flex: 1; padding: 0.2rem; background: #444; border: 1px solid #555; border-radius: 2px; color: #fff; font-size: 0.6rem; margin-left: 0.3rem; }
        
        .image-card-actions { display: flex; gap: 0.2rem; margin-top: 0.3rem; }
        .image-card-actions button { flex: 1; padding: 0.25rem; font-size: 0.6rem; border: none; border-radius: 3px; cursor: pointer; }
        .btn-copy { background: #6c5ce7; color: white; }
        .btn-remove { background: #d63031; color: white; }
        
        .order-badge { position: absolute; top: 4px; left: 4px; background: rgba(0,0,0,0.7); color: white; padding: 0.1rem 0.35rem; border-radius: 3px; font-size: 0.6rem; }
        
        .drop-zone { border: 2px dashed #444; border-radius: 6px; padding: 1.5rem; text-align: center; color: #666; margin-top: 0.8rem; transition: all 0.2s; font-size: 0.8rem; }
        .drop-zone.drag-over { border-color: #007AFF; background: rgba(0, 122, 255, 0.1); color: #007AFF; }
        
        /* Videos */
        .video-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #333; border-radius: 4px; margin-bottom: 0.4rem; }
        .video-item select { width: 80px; padding: 0.3rem; font-size: 0.75rem; }
        .video-item input { flex: 1; padding: 0.3rem; font-size: 0.75rem; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: #222; border-radius: 8px; padding: 1.5rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-header h3 { font-size: 1rem; }
        .modal-close { background: none; border: none; color: #888; font-size: 1.3rem; cursor: pointer; }
        
        .export-preview { background: #111; border-radius: 4px; padding: 0.8rem; font-family: monospace; font-size: 0.6rem; max-height: 250px; overflow: auto; white-space: pre-wrap; color: #0f0; }
        
        .copy-list { display: flex; flex-direction: column; gap: 0.4rem; }
        .copy-item { padding: 0.7rem; background: #333; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
        .copy-item:hover { background: #007AFF; }
        
        .toast { position: fixed; bottom: 1.5rem; right: 1.5rem; background: #28a745; color: white; padding: 0.7rem 1rem; border-radius: 4px; display: none; z-index: 1001; font-size: 0.8rem; }
        .toast.active { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .empty-state { text-align: center; padding: 3rem; color: #666; }
        .empty-state h3 { margin-bottom: 0.5rem; font-weight: 400; }
    </style>
</head>
<body>
    <header class="header">
        <h1>üì∑ Admin Portfolio</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="importConfig()">üì• Importer</button>
            <button class="btn btn-success" onclick="exportConfig()">üíæ Exporter</button>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-tabs">
                <div class="sidebar-tab active" data-tab="menu" onclick="switchTab('menu')">Menu</div>
                <div class="sidebar-tab" data-tab="galleries" onclick="switchTab('galleries')">Galeries</div>
                <div class="sidebar-tab" data-tab="pages" onclick="switchTab('pages')">Pages</div>
            </div>
            <div class="sidebar-content" id="sidebarContent"></div>
        </aside>
        
        <main class="main" id="mainContent">
            <div class="empty-state">
                <h3>Bienvenue</h3>
                <p>S√©lectionne un √©l√©ment √† √©diter</p>
            </div>
        </main>
    </div>

    <!-- Modal Export -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Exporter</h3>
                <button class="modal-close" onclick="closeModal('exportModal')">&times;</button>
            </div>
            <pre class="export-preview" id="exportPreview"></pre>
            <div style="margin-top: 1rem; display: flex; gap: 0.6rem;">
                <button class="btn btn-primary" onclick="copyToClipboard()">üìã Copier</button>
                <button class="btn btn-success" onclick="downloadFile()">‚¨áÔ∏è T√©l√©charger</button>
            </div>
        </div>
    </div>

    <!-- Modal Copy -->
    <div class="modal" id="copyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Copier vers...</h3>
                <button class="modal-close" onclick="closeModal('copyModal')">&times;</button>
            </div>
            <div class="copy-list" id="copyList"></div>
        </div>
    </div>

    <!-- Modal Link Gallery -->
    <div class="modal" id="linkModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Lier √† une galerie</h3>
                <button class="modal-close" onclick="closeModal('linkModal')">&times;</button>
            </div>
            <div class="copy-list" id="linkList"></div>
        </div>
    </div>

    <div class="toast" id="toast">Sauvegard√© !</div>

    <script>
        const MAX_DESC = 200;
        const PHOTODECK_BASE = "https://bertrandbasset.photodeck.com";
        
        // √âtat
        let currentTab = 'menu';
        let currentGallery = null;
        let currentPage = null;
        let copyingImage = null;
        let linkingMenuItem = null;
        
        // Configuration du menu (structure arborescente)
        let menuConfig = [
            {
                id: 'photographe',
                name: 'Photographe',
                type: 'category',
                children: [
                    { id: 'portrait', name: 'Portrait', type: 'gallery', galleryId: 'portrait' },
                    {
                        id: 'serie-portrait',
                        name: 'S√©rie Portrait',
                        type: 'subcategory',
                        children: [
                            { id: 'gem-menu', name: 'Le GEM s\'endimanche', type: 'gallery', galleryId: 'gem' },
                            { id: 'carre-das-menu', name: 'Carr√© d\'As', type: 'gallery', galleryId: 'carre-das' }
                        ]
                    },
                    {
                        id: 'immersion',
                        name: 'Immersion',
                        type: 'subcategory',
                        children: [
                            { id: 'burning-man-menu', name: 'Burning Man', type: 'gallery', galleryId: 'burning-man' },
                            { id: 'st-melar-menu', name: 'St M√©lar', type: 'gallery', galleryId: 'st-melar' }
                        ]
                    }
                ]
            },
            {
                id: 'realisateur',
                name: 'R√©alisateur',
                type: 'category',
                children: [
                    { id: 'cinema-menu', name: 'Cin√©ma', type: 'gallery', galleryId: 'cinema' },
                    { id: 'television-menu', name: 'T√©l√©vision', type: 'gallery', galleryId: 'television' }
                ]
            },
            {
                id: 'galerie-link',
                name: 'Galerie',
                type: 'external',
                url: 'https://bertrandbasset.photodeck.com'
            },
            {
                id: 'prestations',
                name: 'Prestations',
                type: 'category',
                children: [
                    { id: 'presta-portrait', name: 'Portrait', type: 'page', pageId: 'presta-portrait' },
                    { id: 'presta-headshot', name: 'Headshot Corporate', type: 'page', pageId: 'presta-headshot' },
                    { id: 'presta-immersion', name: 'Immersion M√©tier', type: 'page', pageId: 'presta-immersion' },
                    { id: 'presta-empreinte', name: 'Empreinte', type: 'page', pageId: 'presta-empreinte' }
                ]
            },
            { id: 'about-menu', name: '√Ä propos', type: 'page', pageId: 'about' },
            { id: 'contact-menu', name: 'Contact', type: 'page', pageId: 'contact' }
        ];
        
        // Galeries
        let galleriesConfig = {
            "accueil": { title: "Accueil", path: "images/accueil", description: "", autoplayAudio: false, videos: [], images: [] },
            "portrait": { title: "Portrait", path: "images/photography/portrait", description: "", videos: [], images: [] },
            "gem": { title: "Le GEM s'endimanche", path: "images/photography/serie-portrait/gem", description: "", projectTitle: "Le GEM s'endimanche", autoplayAudio: true, videos: [], images: [] },
            "carre-das": { title: "Carr√© d'As", path: "images/photography/serie-portrait/Carr√© D'as", description: "", videos: [], images: [] },
            "burning-man": { title: "Burning Man", path: "images/photography/immersion/Burning Man", description: "", videos: [], images: [] },
            "st-melar": { title: "St M√©lar", path: "images/photography/immersion/St M√©lar", description: "", videos: [], images: [] },
            "cinema": { title: "Cin√©ma", path: "images/filmmaker/cinema", description: "", videos: [], images: [] },
            "television": { title: "T√©l√©vision", path: "images/filmmaker/Television", description: "", videos: [], images: [] }
        };
        
        // Pages
        let pagesConfig = {
            "about": { title: "√Ä propos", content: "Bertrand Basset\nPhotographe & R√©alisateur\n\nBas√© en Bretagne..." },
            "contact": { title: "Contact", content: "contact@bertrandbasset.com\nCarantec, Finist√®re" },
            "presta-portrait": { title: "Portrait", content: "S√©ance portrait en studio ou en ext√©rieur.", price: "", link: "" },
            "presta-headshot": { title: "Headshot Corporate", content: "Portraits professionnels pour LinkedIn, CV, sites web.", price: "", link: "" },
            "presta-immersion": { title: "Immersion M√©tier", content: "Reportage photo au c≈ìur de votre activit√©.", price: "", link: "" },
            "presta-empreinte": { title: "Empreinte", content: "Entretien film√© pour conserver la m√©moire de vos proches.", price: "", link: "" }
        };
        
        // Project pages
        let projectPagesConfig = {};
        
        // Audio files
        let audioFiles = {};

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadSavedConfig();
            renderSidebar();
        });

        function loadSavedConfig() {
            const saved = localStorage.getItem('portfolioConfigV4');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.menu) menuConfig = data.menu;
                    if (data.galleries) galleriesConfig = { ...galleriesConfig, ...data.galleries };
                    if (data.pages) pagesConfig = { ...pagesConfig, ...data.pages };
                    if (data.projectPages) projectPagesConfig = data.projectPages;
                    if (data.audioFiles) audioFiles = data.audioFiles;
                } catch(e) { console.error('Load error:', e); }
            }
        }

        function saveConfig() {
            localStorage.setItem('portfolioConfigV4', JSON.stringify({
                menu: menuConfig,
                galleries: galleriesConfig,
                pages: pagesConfig,
                projectPages: projectPagesConfig,
                audioFiles: audioFiles
            }));
            showToast('Sauvegard√© !');
        }

        // Tabs
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
            renderSidebar();
        }

        function renderSidebar() {
            const content = document.getElementById('sidebarContent');
            if (currentTab === 'menu') renderMenuTab(content);
            else if (currentTab === 'galleries') renderGalleriesTab(content);
            else if (currentTab === 'pages') renderPagesTab(content);
        }

        // Menu Tab
        function renderMenuTab(container) {
            let html = `
                <div class="menu-section">
                    <div class="menu-section-header">
                        <span class="menu-section-title">Structure du menu</span>
                    </div>
                    <div class="menu-tree" id="menuTree">
                        ${renderMenuItems(menuConfig, 0)}
                    </div>
                    <div class="add-menu-item">
                        <input type="text" id="newMenuItemName" placeholder="Nouvel √©l√©ment...">
                        <button class="btn btn-primary btn-small" onclick="addMenuItem()">+</button>
                    </div>
                </div>
            `;
            container.innerHTML = html;
            initMenuDragDrop();
        }

        function renderMenuItems(items, level) {
            return items.map((item, index) => {
                const hasChildren = item.children && item.children.length > 0;
                const typeIcon = item.type === 'external' ? 'üîó' : item.type === 'gallery' ? 'üñºÔ∏è' : item.type === 'page' ? 'üìÑ' : 'üìÅ';
                
                return `
                    <div class="menu-item ${hasChildren ? '' : ''}" data-id="${item.id}" data-index="${index}" data-level="${level}" draggable="true">
                        <div class="menu-item-header">
                            <span class="drag-handle">‚ãÆ‚ãÆ</span>
                            ${hasChildren ? `<button class="menu-item-toggle" onclick="toggleMenuItem('${item.id}')">‚ñ∂</button>` : `<span style="width:18px"></span>`}
                            <span class="menu-item-name">
                                <input value="${item.name}" onchange="renameMenuItem('${item.id}', this.value)" onclick="event.stopPropagation()">
                            </span>
                            <span style="font-size:0.7rem">${typeIcon}</span>
                            <div class="menu-item-actions">
                                ${item.type === 'category' || item.type === 'subcategory' ? `<button onclick="addChildMenuItem('${item.id}')" title="Ajouter enfant">+</button>` : ''}
                                ${item.type === 'gallery' ? `<button onclick="openLinkModal('${item.id}')" title="Lier galerie">üîó</button>` : ''}
                                <button onclick="deleteMenuItem('${item.id}')" title="Supprimer">√ó</button>
                            </div>
                        </div>
                        ${hasChildren ? `
                            <div class="menu-item-children">
                                ${renderMenuItems(item.children, level + 1)}
                            </div>
                        ` : ''}
                        ${item.galleryId ? `<div class="menu-item-link">‚Üí ${galleriesConfig[item.galleryId]?.title || item.galleryId}</div>` : ''}
                        ${item.url ? `<div class="menu-item-link">‚Üí ${item.url}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function toggleMenuItem(id) {
            const el = document.querySelector(`.menu-item[data-id="${id}"]`);
            if (el) el.classList.toggle('open');
        }

        function renameMenuItem(id, newName) {
            function findAndRename(items) {
                for (let item of items) {
                    if (item.id === id) { item.name = newName; return true; }
                    if (item.children && findAndRename(item.children)) return true;
                }
                return false;
            }
            findAndRename(menuConfig);
            saveConfig();
        }

        function addMenuItem() {
            const input = document.getElementById('newMenuItemName');
            const name = input.value.trim();
            if (!name) return;
            
            const id = 'menu-' + Date.now();
            menuConfig.push({ id, name, type: 'category', children: [] });
            input.value = '';
            saveConfig();
            renderSidebar();
        }

        function addChildMenuItem(parentId) {
            const name = prompt('Nom du sous-√©l√©ment:');
            if (!name) return;
            
            function findAndAdd(items) {
                for (let item of items) {
                    if (item.id === parentId) {
                        if (!item.children) item.children = [];
                        const id = 'menu-' + Date.now();
                        item.children.push({ id, name, type: 'gallery', galleryId: null });
                        return true;
                    }
                    if (item.children && findAndAdd(item.children)) return true;
                }
                return false;
            }
            findAndAdd(menuConfig);
            saveConfig();
            renderSidebar();
            
            // Open parent
            setTimeout(() => {
                document.querySelector(`.menu-item[data-id="${parentId}"]`)?.classList.add('open');
            }, 50);
        }

        function deleteMenuItem(id) {
            if (!confirm('Supprimer cet √©l√©ment ?')) return;
            
            function findAndDelete(items) {
                const index = items.findIndex(item => item.id === id);
                if (index !== -1) { items.splice(index, 1); return true; }
                for (let item of items) {
                    if (item.children && findAndDelete(item.children)) return true;
                }
                return false;
            }
            findAndDelete(menuConfig);
            saveConfig();
            renderSidebar();
        }

        function openLinkModal(menuItemId) {
            linkingMenuItem = menuItemId;
            const list = document.getElementById('linkList');
            list.innerHTML = Object.entries(galleriesConfig)
                .map(([id, g]) => `<div class="copy-item" onclick="linkMenuToGallery('${id}')">${g.title}</div>`)
                .join('');
            list.innerHTML += `<div class="copy-item" style="background:#444" onclick="linkMenuToExternal()">üîó Lien externe...</div>`;
            list.innerHTML += `<div class="copy-item" style="background:#444" onclick="linkMenuToPage()">üìÑ Page...</div>`;
            document.getElementById('linkModal').classList.add('active');
        }

        function linkMenuToGallery(galleryId) {
            function findAndLink(items) {
                for (let item of items) {
                    if (item.id === linkingMenuItem) {
                        item.type = 'gallery';
                        item.galleryId = galleryId;
                        delete item.url;
                        delete item.pageId;
                        return true;
                    }
                    if (item.children && findAndLink(item.children)) return true;
                }
                return false;
            }
            findAndLink(menuConfig);
            closeModal('linkModal');
            saveConfig();
            renderSidebar();
        }

        function linkMenuToExternal() {
            const url = prompt('URL externe:', 'https://');
            if (!url) return;
            
            function findAndLink(items) {
                for (let item of items) {
                    if (item.id === linkingMenuItem) {
                        item.type = 'external';
                        item.url = url;
                        delete item.galleryId;
                        delete item.pageId;
                        return true;
                    }
                    if (item.children && findAndLink(item.children)) return true;
                }
                return false;
            }
            findAndLink(menuConfig);
            closeModal('linkModal');
            saveConfig();
            renderSidebar();
        }

        function linkMenuToPage() {
            const pageId = prompt('ID de la page:', 'nouvelle-page');
            if (!pageId) return;
            
            if (!pagesConfig[pageId]) {
                pagesConfig[pageId] = { title: pageId, content: '' };
            }
            
            function findAndLink(items) {
                for (let item of items) {
                    if (item.id === linkingMenuItem) {
                        item.type = 'page';
                        item.pageId = pageId;
                        delete item.galleryId;
                        delete item.url;
                        return true;
                    }
                    if (item.children && findAndLink(item.children)) return true;
                }
                return false;
            }
            findAndLink(menuConfig);
            closeModal('linkModal');
            saveConfig();
            renderSidebar();
        }

        function initMenuDragDrop() {
            const items = document.querySelectorAll('.menu-item[data-level="0"]');
            items.forEach(item => {
                item.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', item.dataset.id);
                    item.classList.add('dragging');
                });
                item.addEventListener('dragend', () => item.classList.remove('dragging'));
                item.addEventListener('dragover', e => { e.preventDefault(); item.classList.add('drag-over'); });
                item.addEventListener('dragleave', () => item.classList.remove('drag-over'));
                item.addEventListener('drop', e => {
                    e.preventDefault();
                    item.classList.remove('drag-over');
                    const fromId = e.dataTransfer.getData('text/plain');
                    const toId = item.dataset.id;
                    if (fromId !== toId) reorderMenuItems(fromId, toId);
                });
            });
        }

        function reorderMenuItems(fromId, toId) {
            const fromIndex = menuConfig.findIndex(m => m.id === fromId);
            const toIndex = menuConfig.findIndex(m => m.id === toId);
            if (fromIndex === -1 || toIndex === -1) return;
            
            const [moved] = menuConfig.splice(fromIndex, 1);
            menuConfig.splice(toIndex, 0, moved);
            saveConfig();
            renderSidebar();
        }

        // Galleries Tab
        function renderGalleriesTab(container) {
            let html = `
                <div class="menu-section">
                    <div class="menu-section-header">
                        <span class="menu-section-title">Galeries</span>
                        <button class="btn btn-primary btn-small" onclick="addGallery()">+</button>
                    </div>
                    ${Object.entries(galleriesConfig).map(([id, g]) => `
                        <div class="gallery-list-item ${currentGallery === id ? 'active' : ''}" onclick="editGallery('${id}')">
                            <span class="name">${g.title}</span>
                            <span class="count">${g.images.length}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            container.innerHTML = html;
        }

        function addGallery() {
            const name = prompt('Nom de la galerie:');
            if (!name) return;
            const id = name.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]+/g, '-');
            if (galleriesConfig[id]) { alert('Existe d√©j√† !'); return; }
            galleriesConfig[id] = { title: name, path: 'images/', description: '', videos: [], images: [] };
            saveConfig();
            renderSidebar();
            editGallery(id);
        }

        function editGallery(id) {
            currentGallery = id;
            currentPage = null;
            renderSidebar();
            renderGalleryEditor(id);
        }

        function renderGalleryEditor(id) {
            const g = galleriesConfig[id];
            const descLen = (g.description || '').length;
            const audios = audioFiles[id] || [];
            const hasAudioImages = g.images.some(img => typeof img === 'object' && img.audio);
            
            document.getElementById('mainContent').innerHTML = `
                <div class="editor-section">
                    <div class="editor-section-title">
                        ${g.title}
                        <button class="btn btn-danger btn-small" onclick="deleteGallery('${id}')">Supprimer</button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Titre</label>
                            <input value="${g.title}" onchange="updateGallery('${id}', 'title', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Chemin images</label>
                            <input value="${g.path}" onchange="updateGallery('${id}', 'path', this.value)">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Description (1√®re slide) <span class="char-count ${descLen > MAX_DESC ? 'over' : ''}">${descLen}/${MAX_DESC}</span></label>
                        <textarea maxlength="${MAX_DESC}" onchange="updateGallery('${id}', 'description', this.value)">${g.description || ''}</textarea>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="hasProject" ${g.projectTitle ? 'checked' : ''} onchange="toggleProject('${id}', this.checked)">
                        <label for="hasProject">Page "En savoir plus"</label>
                    </div>
                    
                    ${g.projectTitle ? `
                        <div class="form-group" style="margin-top:0.5rem;padding:0.8rem;background:#1a3a1a;border-radius:4px;">
                            <label>Contenu de la page projet</label>
                            <textarea style="min-height:120px;" onchange="projectPagesConfig['${id}']=this.value;saveConfig();">${projectPagesConfig[id] || ''}</textarea>
                        </div>
                    ` : ''}
                    
                    ${hasAudioImages ? `
                        <div class="checkbox-group">
                            <input type="checkbox" id="autoplay" ${g.autoplayAudio ? 'checked' : ''} onchange="updateGallery('${id}', 'autoplayAudio', this.checked)">
                            <label for="autoplay">üîä Autoplay audio</label>
                        </div>
                    ` : ''}
                </div>
                
                <div class="editor-section">
                    <div class="editor-section-title">
                        Vid√©os
                        <button class="btn btn-primary btn-small" onclick="addVideo('${id}')">+ Vid√©o</button>
                    </div>
                    <div id="videosList">${renderVideos(id)}</div>
                </div>
                
                <div class="editor-section">
                    <div class="editor-section-title">Images (${g.images.length})</div>
                    <div class="images-grid" id="imagesGrid">${renderImages(id, audios)}</div>
                    <div class="drop-zone" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleFileDrop(event, '${id}')">
                        üìÅ Glisse images ou MP3
                    </div>
                </div>
            `;
            
            initImagesDragDrop(id);
        }

        function updateGallery(id, field, value) {
            galleriesConfig[id][field] = value;
            saveConfig();
            if (field === 'title') renderSidebar();
        }

        function toggleProject(id, enabled) {
            if (enabled) {
                galleriesConfig[id].projectTitle = galleriesConfig[id].title;
            } else {
                delete galleriesConfig[id].projectTitle;
            }
            saveConfig();
            renderGalleryEditor(id);
        }

        function deleteGallery(id) {
            if (!confirm('Supprimer cette galerie ?')) return;
            delete galleriesConfig[id];
            saveConfig();
            currentGallery = null;
            renderSidebar();
            document.getElementById('mainContent').innerHTML = '<div class="empty-state"><h3>Galerie supprim√©e</h3></div>';
        }

        function renderVideos(id) {
            const g = galleriesConfig[id];
            if (!g.videos || !g.videos.length) return '<p style="color:#666;font-size:0.75rem;">Aucune vid√©o</p>';
            return g.videos.map((v, i) => `
                <div class="video-item">
                    <select onchange="galleriesConfig['${id}'].videos[${i}].type=this.value;saveConfig();">
                        <option value="vimeo" ${v.type === 'vimeo' ? 'selected' : ''}>Vimeo</option>
                        <option value="youtube" ${v.type === 'youtube' ? 'selected' : ''}>YouTube</option>
                    </select>
                    <input placeholder="ID" value="${v.id || ''}" onchange="galleriesConfig['${id}'].videos[${i}].id=this.value;saveConfig();">
                    <input placeholder="Titre" value="${v.title || ''}" onchange="galleriesConfig['${id}'].videos[${i}].title=this.value;saveConfig();">
                    <button class="btn btn-danger btn-small" onclick="galleriesConfig['${id}'].videos.splice(${i},1);saveConfig();renderGalleryEditor('${id}');">√ó</button>
                </div>
            `).join('');
        }

        function addVideo(id) {
            if (!galleriesConfig[id].videos) galleriesConfig[id].videos = [];
            galleriesConfig[id].videos.push({ type: 'vimeo', id: '', title: '' });
            saveConfig();
            renderGalleryEditor(id);
        }

        function renderImages(galleryId, audios) {
            const g = galleriesConfig[galleryId];
            return g.images.map((img, i) => {
                const fn = typeof img === 'string' ? img : img.filename;
                const caption = typeof img === 'object' ? (img.caption || '') : '';
                const audio = typeof img === 'object' ? (img.audio || '') : '';
                const tirage = typeof img === 'object' && img.tirage;
                const tirageUrl = typeof img === 'object' ? (img.tirageUrl || '') : '';
                
                return `
                    <div class="image-card" draggable="true" data-index="${i}">
                        <span class="order-badge">${i + 1}</span>
                        <img src="${g.path}/${fn}" onerror="this.style.background='#333'">
                        <div class="image-card-body">
                            <div class="image-card-title">${fn}</div>
                            <textarea placeholder="L√©gende..." onchange="updateImage('${galleryId}',${i},'caption',this.value)">${caption}</textarea>
                            
                            <div class="image-card-row">
                                <select onchange="updateImage('${galleryId}',${i},'audio',this.value)">
                                    <option value="">Audio</option>
                                    ${audios.map(a => `<option value="${a}" ${a===audio?'selected':''}>${a}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div class="image-option ${tirage ? 'active' : ''}">
                                <input type="checkbox" id="tir-${i}" ${tirage ? 'checked' : ''} onchange="updateImage('${galleryId}',${i},'tirage',this.checked)">
                                <label for="tir-${i}">üõí</label>
                                ${tirage ? `<input type="text" placeholder="URL Photodeck" value="${tirageUrl}" onchange="updateImage('${galleryId}',${i},'tirageUrl',this.value)">` : ''}
                            </div>
                            
                            <div class="image-card-actions">
                                <button class="btn-copy" onclick="openCopyModal('${galleryId}',${i})">üìã</button>
                                <button class="btn-remove" onclick="removeImage('${galleryId}',${i})">√ó</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateImage(galleryId, index, field, value) {
            let img = galleriesConfig[galleryId].images[index];
            if (typeof img === 'string') {
                img = { filename: img };
                galleriesConfig[galleryId].images[index] = img;
            }
            img[field] = value;
            saveConfig();
            if (field === 'tirage') renderGalleryEditor(galleryId);
        }

        function removeImage(galleryId, index) {
            galleriesConfig[galleryId].images.splice(index, 1);
            saveConfig();
            renderGalleryEditor(galleryId);
            renderSidebar();
        }

        function openCopyModal(galleryId, index) {
            copyingImage = { galleryId, index };
            document.getElementById('copyList').innerHTML = Object.entries(galleriesConfig)
                .filter(([id]) => id !== galleryId)
                .map(([id, g]) => `<div class="copy-item" onclick="copyImageTo('${id}')">${g.title}</div>`)
                .join('');
            document.getElementById('copyModal').classList.add('active');
        }

        function copyImageTo(targetId) {
            if (!copyingImage) return;
            const img = galleriesConfig[copyingImage.galleryId].images[copyingImage.index];
            galleriesConfig[targetId].images.push(typeof img === 'string' ? img : { ...img });
            saveConfig();
            closeModal('copyModal');
            showToast('Copi√© !');
            renderSidebar();
        }

        function initImagesDragDrop(galleryId) {
            const grid = document.getElementById('imagesGrid');
            if (!grid) return;
            grid.querySelectorAll('.image-card').forEach(card => {
                card.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', card.dataset.index);
                    card.classList.add('dragging');
                });
                card.addEventListener('dragend', () => card.classList.remove('dragging'));
                card.addEventListener('dragover', e => { e.preventDefault(); card.classList.add('drag-over'); });
                card.addEventListener('dragleave', () => card.classList.remove('drag-over'));
                card.addEventListener('drop', e => {
                    e.preventDefault();
                    card.classList.remove('drag-over');
                    const from = parseInt(e.dataTransfer.getData('text/plain'));
                    const to = parseInt(card.dataset.index);
                    if (from !== to) {
                        const imgs = galleriesConfig[galleryId].images;
                        const [moved] = imgs.splice(from, 1);
                        imgs.splice(to, 0, moved);
                        saveConfig();
                        renderGalleryEditor(galleryId);
                    }
                });
            });
        }

        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        function handleFileDrop(e, galleryId) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            Array.from(e.dataTransfer.files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    galleriesConfig[galleryId].images.push({ filename: file.name });
                }
                if (file.name.endsWith('.mp3')) {
                    if (!audioFiles[galleryId]) audioFiles[galleryId] = [];
                    if (!audioFiles[galleryId].includes(file.name)) audioFiles[galleryId].push(file.name);
                }
            });
            saveConfig();
            renderGalleryEditor(galleryId);
            renderSidebar();
        }

        // Pages Tab
        function renderPagesTab(container) {
            container.innerHTML = `
                <div class="menu-section">
                    <div class="menu-section-header">
                        <span class="menu-section-title">Pages</span>
                        <button class="btn btn-primary btn-small" onclick="addPage()">+</button>
                    </div>
                    ${Object.entries(pagesConfig).map(([id, p]) => `
                        <div class="page-list-item ${currentPage === id ? 'active' : ''}" onclick="editPage('${id}')">
                            ${p.title}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function addPage() {
            const name = prompt('Nom de la page:');
            if (!name) return;
            const id = name.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]+/g, '-');
            pagesConfig[id] = { title: name, content: '' };
            saveConfig();
            renderSidebar();
            editPage(id);
        }

        function editPage(id) {
            currentPage = id;
            currentGallery = null;
            renderSidebar();
            
            const p = pagesConfig[id];
            const isPresta = id.startsWith('presta-');
            
            document.getElementById('mainContent').innerHTML = `
                <div class="editor-section">
                    <div class="editor-section-title">
                        ${p.title}
                        <button class="btn btn-danger btn-small" onclick="deletePage('${id}')">Supprimer</button>
                    </div>
                    
                    <div class="form-group">
                        <label>Titre</label>
                        <input value="${p.title}" onchange="pagesConfig['${id}'].title=this.value;saveConfig();renderSidebar();">
                    </div>
                    
                    <div class="form-group">
                        <label>Contenu</label>
                        <textarea style="min-height:200px;" onchange="pagesConfig['${id}'].content=this.value;saveConfig();">${p.content || ''}</textarea>
                    </div>
                    
                    ${isPresta ? `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Prix indicatif</label>
                                <input value="${p.price || ''}" placeholder="ex: √† partir de 150‚Ç¨" onchange="pagesConfig['${id}'].price=this.value;saveConfig();">
                            </div>
                            <div class="form-group">
                                <label>Lien r√©servation</label>
                                <input value="${p.link || ''}" placeholder="URL Photodeck" onchange="pagesConfig['${id}'].link=this.value;saveConfig();">
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function deletePage(id) {
            if (!confirm('Supprimer cette page ?')) return;
            delete pagesConfig[id];
            saveConfig();
            currentPage = null;
            renderSidebar();
            document.getElementById('mainContent').innerHTML = '<div class="empty-state"><h3>Page supprim√©e</h3></div>';
        }

        // Import / Export
        function importConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.js';
            input.onchange = async e => {
                const file = e.target.files[0];
                if (!file) return;
                const text = await file.text();
                try {
                    // Import galleries
                    const galMatch = text.match(/const GALLERIES_CONFIG = ({[\s\S]*?});/);
                    if (galMatch) {
                        const config = eval('(' + galMatch[1] + ')');
                        for (const [id, g] of Object.entries(config)) {
                            galleriesConfig[id] = {
                                title: g.title,
                                path: g.path,
                                description: g.description || '',
                                projectTitle: g.projectTitle,
                                autoplayAudio: g.autoplayAudio || false,
                                videos: g.videos || [],
                                images: g.images.map(img => typeof img === 'string' ? { filename: img } : img)
                            };
                            audioFiles[id] = [];
                            g.images.forEach(img => {
                                if (typeof img === 'object' && img.audio) {
                                    const name = img.audio.split('/').pop();
                                    if (!audioFiles[id].includes(name)) audioFiles[id].push(name);
                                }
                            });
                        }
                    }
                    saveConfig();
                    renderSidebar();
                    showToast('Import√© !');
                } catch(err) { alert('Erreur: ' + err.message); }
            };
            input.click();
        }

        function exportConfig() {
            document.getElementById('exportPreview').textContent = generateJS();
            document.getElementById('exportModal').classList.add('active');
        }

        function generateJS() {
            // Generate menu structure for HTML
            let menuHTML = generateMenuHTML(menuConfig);
            
            // Generate JS config
            let js = `/**
 * Bertrand Basset Portfolio
 * Auto-generated
 */

const MENU_CONFIG = ${JSON.stringify(menuConfig, null, 2)};

const GALLERIES_CONFIG = {\n`;

            for (const [id, g] of Object.entries(galleriesConfig)) {
                js += `    "${id}": {\n`;
                js += `        title: "${g.title}",\n`;
                js += `        path: "${g.path}",\n`;
                if (g.description) js += `        description: "${g.description.replace(/"/g, '\\"').replace(/\n/g, '\\n')}",\n`;
                if (g.projectTitle) js += `        projectTitle: "${g.projectTitle}",\n`;
                if (g.autoplayAudio) js += `        autoplayAudio: true,\n`;
                if (g.videos && g.videos.length) {
                    js += `        videos: [${g.videos.map(v => `{ type: "${v.type}", id: "${v.id}", title: "${v.title || ''}" }`).join(', ')}],\n`;
                }
                js += `        images: [\n`;
                g.images.forEach((img, i) => {
                    const fn = typeof img === 'string' ? img : img.filename;
                    const parts = [`filename: "${fn}"`];
                    if (img.caption) parts.push(`caption: "${img.caption.replace(/"/g, '\\"')}"`);
                    if (img.audio) parts.push(`audio: "${img.audio}"`);
                    if (img.tirage) parts.push(`tirage: true`);
                    if (img.tirageUrl) parts.push(`tirageUrl: "${img.tirageUrl}"`);
                    js += `            { ${parts.join(', ')} }${i < g.images.length - 1 ? ',' : ''}\n`;
                });
                js += `        ]\n    },\n`;
            }
            js += `};\n\n`;
            
            js += `const PAGES_CONFIG = ${JSON.stringify(pagesConfig, null, 2)};\n\n`;
            js += `const PROJECT_PAGES = ${JSON.stringify(projectPagesConfig, null, 2)};\n\n`;
            
            return js + getPortfolioClassCode();
        }

        function generateMenuHTML(items, level = 0) {
            // This would generate the HTML for index.html
            return items.map(item => {
                if (item.type === 'category' || item.type === 'subcategory') {
                    return `<nav-item>${item.name}...children</nav-item>`;
                }
                return `<link>${item.name}</link>`;
            }).join('\n');
        }

        function getPortfolioClassCode() {
            return `
const TRANSLATIONS = {
    en: { "prev": "prev", "next": "next", "show-thumbnails": "thumbnails", "hide-thumbnails": "hide", "play": "play", "pause": "pause", "buy-print": "Buy print" },
    fr: { "prev": "pr√©c", "next": "suiv", "show-thumbnails": "vignettes", "hide-thumbnails": "masquer", "play": "√©couter", "pause": "pause", "buy-print": "Acheter" }
};

class Portfolio {
    constructor() {
        this.galleries = this.buildGalleries();
        this.currentGallery = null;
        this.currentIndex = 0;
        this.isTransitioning = false;
        this.currentAudio = null;
        this.isPlaying = false;
        this.currentLang = 'fr';
        this.isMobile = window.innerWidth <= 768;
        this.autoplayAudio = false;
        this.init();
    }

    buildGalleries() {
        const galleries = {};
        for (const [id, config] of Object.entries(GALLERIES_CONFIG)) {
            const items = [];
            if (config.description) items.push({ type: 'description', title: config.title, text: config.description });
            if (config.videos) config.videos.forEach(v => items.push({ type: 'video', platform: v.type, videoId: v.id, title: v.title }));
            config.images.forEach(img => {
                items.push({
                    type: 'image',
                    src: \`\${config.path}/\${img.filename}\`,
                    caption: img.caption || '',
                    audio: img.audio ? \`\${config.path}/\${img.audio}\` : null,
                    tirage: img.tirage,
                    tirageUrl: img.tirageUrl
                });
            });
            galleries[id] = { ...config, items };
        }
        return galleries;
    }

    init() {
        this.cacheElements();
        this.bindEvents();
        this.openGallery('accueil');
    }

    cacheElements() {
        this.landing = document.getElementById('landing');
        this.site = document.getElementById('site');
        this.enterBtn = document.getElementById('enterBtn');
        this.menuToggle = document.getElementById('menuToggle');
        this.mainNav = document.getElementById('mainNav');
        this.galleryContainer = document.getElementById('galleryContainer');
        this.galleryCounter = document.querySelector('.gallery-counter');
        this.imageCaption = document.querySelector('.image-caption');
        this.audioControls = document.querySelector('.audio-controls');
        this.audioBtn = document.getElementById('audioBtn');
        this.autoplayToggle = document.getElementById('autoplayToggle');
        this.homeLink = document.getElementById('homeLink');
        this.cursor = document.getElementById('customCursor');
        this.navItems = document.querySelectorAll('.nav-item[data-expandable]');
        this.dropdownLinks = document.querySelectorAll('[data-gallery]');
        this.pageLinks = document.querySelectorAll('[data-page]');
    }

    bindEvents() {
        if (this.enterBtn) this.enterBtn.onclick = () => this.enterSite();
        if (this.homeLink) this.homeLink.onclick = e => { e.preventDefault(); this.openGallery('accueil'); };
        if (this.menuToggle) this.menuToggle.onclick = () => this.toggleMenu();
        
        this.navItems.forEach(item => {
            const link = item.querySelector('.nav-link');
            if (link) link.onclick = e => { e.preventDefault(); item.classList.toggle('open'); };
        });
        
        this.dropdownLinks.forEach(link => {
            link.onclick = e => { e.preventDefault(); this.openGallery(link.dataset.gallery); this.closeMenu(); };
        });
        
        this.pageLinks.forEach(link => {
            link.onclick = e => { e.preventDefault(); this.showPage(link.dataset.page); this.closeMenu(); };
        });
        
        if (this.galleryContainer) {
            this.galleryContainer.onclick = e => {
                if (e.target.closest('.video-container, .buy-button')) return;
                const rect = this.galleryContainer.getBoundingClientRect();
                (e.clientX - rect.left) < rect.width / 2 ? this.prev() : this.next();
            };
        }
        
        if (this.audioBtn) this.audioBtn.onclick = () => this.toggleAudio();
        if (this.autoplayToggle) this.autoplayToggle.onchange = () => { this.autoplayAudio = this.autoplayToggle.checked; };
        
        document.onkeydown = e => {
            if (e.key === 'ArrowLeft') this.prev();
            if (e.key === 'ArrowRight') this.next();
            if (e.key === ' ') { e.preventDefault(); this.toggleAudio(); }
        };
        
        this.initSwipe();
    }

    enterSite() { this.landing?.classList.add('hidden'); this.site?.classList.add('active'); }
    toggleMenu() { this.menuToggle?.classList.toggle('open'); this.mainNav?.classList.toggle('open'); }
    closeMenu() { this.menuToggle?.classList.remove('open'); this.mainNav?.classList.remove('open'); }

    openGallery(id) {
        const g = this.galleries[id];
        if (!g?.items.length) return;
        this.currentGallery = g;
        this.currentIndex = 0;
        this.autoplayAudio = g.autoplayAudio || false;
        if (this.autoplayToggle) this.autoplayToggle.checked = this.autoplayAudio;
        this.showItem(0);
    }

    showItem(index) {
        if (!this.currentGallery || this.isTransitioning) return;
        const items = this.currentGallery.items;
        if (index < 0 || index >= items.length) return;
        
        this.stopAudio();
        this.isTransitioning = true;
        this.currentIndex = index;
        const item = items[index];
        
        setTimeout(() => {
            this.galleryContainer.innerHTML = '';
            
            if (item.type === 'description') {
                this.galleryContainer.innerHTML = \`<div class="description-slide loaded"><div class="description-content"><h2>\${item.title}</h2><p>\${item.text}</p></div></div>\`;
            } else if (item.type === 'video') {
                const url = item.platform === 'vimeo' ? \`https://player.vimeo.com/video/\${item.videoId}\` : \`https://www.youtube.com/embed/\${item.videoId}\`;
                this.galleryContainer.innerHTML = \`<div class="video-container loaded"><iframe src="\${url}" frameborder="0" allowfullscreen></iframe></div>\`;
            } else {
                const wrapper = document.createElement('div');
                wrapper.className = 'image-wrapper';
                const img = document.createElement('img');
                img.className = 'gallery-image';
                img.onload = () => { img.classList.add('loaded'); this.isTransitioning = false; };
                img.src = encodeURI(item.src);
                wrapper.appendChild(img);
                
                if (item.tirage && item.tirageUrl) {
                    wrapper.innerHTML += \`<a class="buy-button" href="\${item.tirageUrl}" target="_blank">üõí \${TRANSLATIONS[this.currentLang]['buy-print']}</a>\`;
                }
                this.galleryContainer.appendChild(wrapper);
                
                if (item.audio && this.autoplayAudio) this.playAudio(item.audio);
            }
            
            this.updateUI(item);
            this.isTransitioning = false;
        }, 200);
    }

    updateUI(item) {
        if (this.galleryCounter) this.galleryCounter.textContent = \`\${this.currentIndex + 1} / \${this.currentGallery.items.length}\`;
        if (this.imageCaption) this.imageCaption.textContent = item.caption || '';
        if (this.audioControls) this.audioControls.classList.toggle('visible', item.type === 'image' && !!item.audio);
    }

    prev() { if (this.currentGallery) this.showItem(this.currentIndex > 0 ? this.currentIndex - 1 : this.currentGallery.items.length - 1); }
    next() { if (this.currentGallery) this.showItem(this.currentIndex < this.currentGallery.items.length - 1 ? this.currentIndex + 1 : 0); }

    playAudio(src) {
        this.stopAudio();
        this.currentAudio = new Audio(encodeURI(src));
        this.currentAudio.play().catch(() => {});
        this.isPlaying = true;
        this.updateAudioBtn();
        this.currentAudio.onended = () => { this.isPlaying = false; this.updateAudioBtn(); };
    }
    stopAudio() { if (this.currentAudio) { this.currentAudio.pause(); this.currentAudio = null; } this.isPlaying = false; this.updateAudioBtn(); }
    toggleAudio() {
        const item = this.currentGallery?.items[this.currentIndex];
        if (!item?.audio) return;
        this.isPlaying ? this.stopAudio() : this.playAudio(item.audio);
    }
    updateAudioBtn() {
        if (!this.audioBtn) return;
        this.audioBtn.innerHTML = this.isPlaying ? '‚è∏' : '‚ñ∂';
        this.audioBtn.classList.toggle('playing', this.isPlaying);
    }

    showPage(id) {
        const page = PAGES_CONFIG[id];
        if (!page) return;
        this.currentGallery = null;
        if (this.galleryCounter) this.galleryCounter.style.display = 'none';
        if (this.audioControls) this.audioControls.classList.remove('visible');
        
        let html = \`<div class="page-content"><div class="page-text">\${page.content.replace(/\\n/g, '<br>')}</div>\`;
        if (page.price) html += \`<div class="page-price">\${page.price}</div>\`;
        if (page.link) html += \`<a class="page-btn" href="\${page.link}" target="_blank">R√©server</a>\`;
        html += '</div>';
        this.galleryContainer.innerHTML = html;
    }

    initSwipe() {
        let startX;
        this.galleryContainer?.addEventListener('touchstart', e => startX = e.touches[0].clientX);
        this.galleryContainer?.addEventListener('touchend', e => {
            const diff = startX - e.changedTouches[0].clientX;
            if (Math.abs(diff) > 50) diff > 0 ? this.next() : this.prev();
        });
    }
}

document.addEventListener('DOMContentLoaded', () => new Portfolio());
`;
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function copyToClipboard() { navigator.clipboard.writeText(document.getElementById('exportPreview').textContent).then(() => showToast('Copi√© !')); }
        function downloadFile() {
            const blob = new Blob([document.getElementById('exportPreview').textContent], { type: 'text/javascript' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'gallery.js';
            a.click();
            showToast('T√©l√©charg√© !');
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('active');
            setTimeout(() => t.classList.remove('active'), 2000);
        }
        document.querySelectorAll('.modal').forEach(m => m.onclick = e => { if (e.target === m) m.classList.remove('active'); });
    </script>
</body>
</html>
